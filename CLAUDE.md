# CLAUDE.md

此文件为 Claude Code 在此代码仓库中工作时提供指导。

## 项目概述

基于 Flask 的实时服务器监控仪表板，使用 WebSocket 提供系统资源监控、端口状态检查和进程管理功能，包含身份验证和防暴力破解保护。新增内存使用排行TOP 15功能、**Web终端**功能和**DNS服务器**功能，可实时查看和管理高内存占用进程，直接在浏览器中使用完整的Linux终端，并提供带广告屏蔽的DNS解析服务。

## 核心组件

- `app.py` - Flask 主应用，处理路由和 WebSocket
- `app/auth.py` - 身份验证和安全管理
- `app/monitor.py` - 使用 psutil 收集系统数据
- `app/terminal.py` - Web终端会话管理（新增）
- `app/dns_server.py` - DNS服务器和广告屏蔽（新增）
- `app/dns_manager.py` - DNS统计和管理
- `app/adblock.py` - 广告屏蔽引擎
- `config/config.py` - 配置管理（包含密码设置）

## 开发命令

### 快速启动（推荐）

```bash
# 一键启动脚本 - 自动处理环境和依赖
./start.sh
```

启动脚本功能：
- 自动创建和激活虚拟环境
- 自动安装依赖包
- 检测端口冲突并提供解决方案
- 显示访问地址和登录信息
- 彩色输出和友好提示

仪表板主要功能：
- 实时系统资源监控（CPU、内存、磁盘、网络）
- 内存使用排行TOP 15（可终止进程）
- 端口状态监控和进程管理
- 系统服务状态监控
- 安全的进程终止功能（保护系统关键进程）
- **🖥️ Web终端** - 浏览器内完整Linux终端体验，支持移动端
- **🌐 DNS服务器** - 带广告屏蔽功能的DNS解析服务（端口8053）

### 手动启动

```bash
# 环境设置
python3 -m venv venv && source venv/bin/activate
pip install -r requirements.txt

# 运行开发服务器
python app.py
# 访问: http://localhost:5000 或 http://服务器IP:5000
# 密码: 在 .env 文件中设置的 DASHBOARD_PASSWORD
```

### 生产部署

```bash
# 使用完整安装脚本
./install.sh

# 或手动部署
sudo cp config/dashboard.service /etc/systemd/system/
sudo systemctl daemon-reload && sudo systemctl enable dashboard && sudo systemctl start dashboard
```

## 配置说明

### 密码配置（重要）
首次部署前必须设置密码：
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，设置你的密码
nano .env
# 修改：DASHBOARD_PASSWORD=your_secure_password_here
```

### 其他配置
- HTTPS 环境需设置 `SESSION_COOKIE_SECURE = True` 
- 监控功能：CPU/内存/磁盘/网络资源、系统服务状态、常用端口监控、进程内存排行、进程管理
- 系统要求：Python 3.6+、psutil 权限、端口 5000

## 文件结构

- `app.py` - Flask 主入口
- `start.sh` - 快速启动脚本
- `install.sh` - 完整安装脚本
- `app/` - 认证和监控模块
- `config/` - 配置文件和服务配置
- `templates/` - HTML 模板
- `static/` - 前端资源

## API 接口

- `GET /` - 仪表板（需认证）
- `POST /login` - 登录
- `GET /api/stats` - 系统数据 JSON
- `POST /api/kill_port_process/<port>` - 关闭指定端口的进程（需认证）
- `POST /api/kill_process/<pid>` - 根据PID关闭进程（需认证）
- WebSocket: `request_stats`, `stats_update`, `terminal_create`, `terminal_input`, `terminal_resize`, `terminal_close`

## 进程管理功能

### 内存使用排行 TOP 15
仪表板新增内存使用排行功能，实时显示占用内存最多的进程：

- **显示信息**：PID、进程名、用户、内存占用（MB）、内存百分比、命令行参数
- **排序规则**：按实际内存使用量（RSS）降序排列
- **实时更新**：通过WebSocket每5秒自动刷新数据
- **详细命令**：鼠标悬停可查看完整命令行参数
- **进程管理**：可直接从界面终止高内存占用进程

### 端口进程管理
仪表板支持直接从界面关闭占用特定端口的进程：

- 在端口监控面板中，开放状态的端口会显示"关闭进程"按钮
- 点击按钮会弹出确认对话框，显示进程详细信息
- 确认后会发送 POST 请求到 `/api/kill_port_process/<port>` 接口

### 通用进程管理
在内存使用排行中可以直接终止进程：

- 每个进程行都有"终止"按钮（受保护进程显示"受保护"）
- 点击"终止"按钮会显示确认对话框，包含进程详细信息
- 确认后发送 POST 请求到 `/api/kill_process/<pid>` 接口
- 系统会优先使用 SIGTERM 信号，3秒后无响应则使用 SIGKILL
- 操作结果通过 Toast 提示显示给用户

### 安全限制
- 只能关闭用户级进程，系统关键服务受保护
- PID < 1000 的 root 进程被跳过
- 保护列表：systemd、init、kernel、kthreadd、ssh、sshd
- root用户的系统进程（PID < 1000）自动受保护

## Web终端功能

### 🖥️ 完整Linux终端体验
新增的Web终端功能让您可以直接在浏览器中使用完整的Linux命令行界面：

#### 主要特性：
- **完整终端支持**：支持所有Linux命令，包括vim、nano、htop等
- **实时响应**：基于WebSocket的零延迟交互
- **多终端会话**：可同时开启多个独立的终端标签页
- **颜色高亮**：支持ANSI颜色和终端样式
- **自动大小调整**：根据浏览器窗口自动调整终端大小

#### 移动端支持：
- **触屏优化**：专为移动设备优化的界面
- **虚拟键盘**：提供Ctrl+C、Tab、方向键等特殊按键
- **响应式设计**：在各种屏幕尺寸下完美显示

#### 使用方法：
1. 登录仪表板后，点击"🖥️ 终端"标签页
2. 点击"新建终端"按钮创建新的终端会话
3. 直接在终端中输入命令，就像使用SSH一样
4. 支持多个终端标签页，点击标签页名称进行切换
5. 点击标签页右上角的"×"关闭终端会话

#### 安全特性：
- **身份验证**：继承仪表板的登录认证系统
- **会话隔离**：每个用户的终端会话完全独立
- **自动清理**：断开连接时自动清理终端进程
- **超时管理**：30分钟无活动自动关闭会话

#### 技术实现：
- **前端**：基于xterm.js的专业终端界面
- **后端**：使用ptyprocess创建伪终端进程
- **通信**：WebSocket实现实时双向数据传输
- **兼容性**：支持所有现代浏览器和移动设备

## DNS服务器功能

### 🌐 带广告屏蔽的DNS解析服务
新增的DNS服务器功能提供安全、快速的域名解析服务，内置强大的广告屏蔽能力：

#### 主要特性：
- **广告屏蔽**：集成多个广告屏蔽列表，自动屏蔽恶意和广告域名
- **上游DNS**：支持多个上游DNS服务器（Google DNS、Cloudflare、114 DNS、阿里DNS）
- **智能缓存**：5分钟DNS缓存提高响应速度
- **实时统计**：查询统计、屏蔽率统计、缓存命中率等
- **高性能**：基于dnspython的高效DNS解析实现

#### 屏蔽列表：
- **EasyList**：主流广告屏蔽列表
- **EasyList China**：中文广告屏蔽
- **AdGuard Base**：AdGuard基础屏蔽列表  
- **Steven Black**：恶意软件和广告屏蔽
- **Malware Domains**：恶意域名屏蔽
- 总计超过30万个屏蔽域名，自动更新

#### 使用方法：
1. 登录仪表板后，点击"🌐 DNS"标签页
2. 点击"启动DNS服务器"按钮
3. DNS服务器将在端口8053启动
4. 配置客户端DNS为服务器IP:8053使用

#### 测试DNS服务器：
```bash
# 测试正常域名解析
dig @服务器IP -p 8053 example.com

# 测试广告域名屏蔽
dig @服务器IP -p 8053 doubleclick.net
```

#### 技术实现：
- **前端**：基于dnspython的DNS消息处理
- **后端**：使用socketserver创建UDP DNS服务器  
- **屏蔽引擎**：高效域名匹配和屏蔽检测
- **统计系统**：实时DNS查询和屏蔽统计
- **缓存机制**：LRU缓存提高解析性能

#### 安全特性：
- **权限控制**：继承仪表板的身份验证系统
- **上游冗余**：多个上游DNS服务器确保可用性
- **屏蔽日志**：记录所有屏蔽的恶意域名访问
- **配置管理**：支持动态更新上游服务器和屏蔽列表

## 常见问题

- 确保 `app/` 和 `config/` 目录有 `__init__.py` 文件
- 检查端口 5000 可用性和防火墙设置  
- HTTP 环境设置 `SESSION_COOKIE_SECURE = False`
- DNS服务器默认端口8053，避免与系统DNS冲突
- 查看日志：`sudo journalctl -u dashboard -f`

## 技术升级记录

### 进程管理表格排序修复 (v2.1)
- **问题**：进程管理页面的CPU%排序功能不可用，表格排序存在列索引错误
- **解决方案**：修复JavaScript中`sortTableRows`函数的列索引映射
- **改进**：
  - 修正CPU排序：从错误的列索引2改为正确的列索引6
  - 修正用户排序：从错误的列索引1改为正确的列索引2  
  - 添加分类和状态列的排序支持
  - 优化内存排序的列索引映射
  - 所有排序功能现在都能正常工作
- **影响**：提升用户体验，方便按各种指标对进程进行排序分析

### DNS服务器实现 (v2.0)
- **问题**：原dnslib库存在端口绑定问题，无法正常启动DNS服务器
- **解决方案**：替换为dnspython + socketserver实现
- **改进**：
  - 使用dnspython库进行DNS消息处理，更加稳定可靠
  - 采用socketserver.UDPServer创建DNS服务器，解决端口绑定问题  
  - 保持所有原有功能：广告屏蔽、缓存、统计、上游查询
  - 测试验证：正常域名解析和广告域名屏蔽功能正常
- **端口**：从53改为8053避免权限问题，再改为8053避免mDNS冲突

### 网站性能全面优化 (v2.2)
- **目标**：减少服务器流量成本，提升网页加载速度和用户体验
- **解决方案**：实施多层次性能优化策略
- **核心优化**：
  - **WebSocket增量更新**：实现数据差异检测，只传输变化的数据，减少70-80%流量
  - **HTTP压缩**：添加Flask-Compress中间件，静态资源gzip压缩率达78-82%
  - **智能缓存**：实现ETags和分层缓存策略，避免重复下载
  - **前端性能**：DOM元素缓存、页面可见性检测、自适应更新频率
  - **系统数据缓存**：静态数据5分钟缓存，服务状态30秒缓存
- **技术细节**：
  - JavaScript文件：112KB → 24KB (压缩率78%)
  - CSS文件：56KB → 9.8KB (压缩率82%)
  - 页面隐藏时更新间隔从5秒增加到15秒
  - 实现增量数据合并和DOM缓存机制
  - 添加ETag支持，正确返回304缓存响应
- **预期效果**：
  - 总体流量减少65-75%，显著降低带宽成本
  - 首次加载速度提升50%，后续响应提升80%
  - 移动端体验显著改善，服务器负载降低40-50%
- **工具支持**：提供`performance_test.py`性能测试脚本和详细优化报告